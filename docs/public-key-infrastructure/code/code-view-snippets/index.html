<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/assets/css/default.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js" integrity="sha512-Tn2m0TIpgVyTzzvmxLNuqbSJH3JP8jm+Cy3hvHrW7ndTDcJ1w5mBiksqDBb8GpE2ksktFvDB/ykZ0mDpsZj20w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" /> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/default.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>View Snippets | Made by mistake</title><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="View Snippets" /><meta property="og:locale" content="en_US" /><meta name="description" content="Made by mistake" /><meta property="og:description" content="Made by mistake" /><link rel="canonical" href="https://lopeaa.github.io/docs/public-key-infrastructure/code/code-view-snippets/" /><meta property="og:url" content="https://lopeaa.github.io/docs/public-key-infrastructure/code/code-view-snippets/" /><meta property="og:site_name" content="Made by mistake" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="View Snippets" /> <script type="application/ld+json"> {"headline":"View Snippets","url":"https://lopeaa.github.io/docs/public-key-infrastructure/code/code-view-snippets/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://lopeaa.github.io/assets/images/logo.png"}},"@type":"WebPage","description":"Made by mistake","@context":"https://schema.org"}</script><body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a href="https://lopeaa.github.io/" class="site-title lh-tight"><div class="site-logo"></div></a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="https://lopeaa.github.io/" class="nav-list-link">Home</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://lopeaa.github.io/docs/public-key-infrastructure" class="nav-list-link">Public Key Infrastructure</a><ul class="nav-list "><li class="nav-list-item "><a href="https://lopeaa.github.io/docs/public-key-infrastructure/certificate-authority/" class="nav-list-link">Certificate Auhtority</a><li class="nav-list-item "><a href="https://lopeaa.github.io/docs/public-key-infrastructure/certificate-monitor/" class="nav-list-link">Certificates Monitor</a><li class="nav-list-item "><a href="https://lopeaa.github.io/docs/public-key-infrastructure/certificate-converter/" class="nav-list-link">Certificate Converter</a><li class="nav-list-item "><a href="https://lopeaa.github.io/docs/public-key-infrastructure/certificate-decoder/" class="nav-list-link">Certificate Decoder</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://lopeaa.github.io/docs/public-key-infrastructure/code-snippets/" class="nav-list-link">Code Snippets</a><ul class="nav-list"><li class="nav-list-item "> <a href="https://lopeaa.github.io/docs/public-key-infrastructure/code/code-model-snippets/" class="nav-list-link">Model Snippets</a><li class="nav-list-item active"> <a href="https://lopeaa.github.io/docs/public-key-infrastructure/code/code-view-snippets/" class="nav-list-link active">View Snippets</a><li class="nav-list-item "> <a href="https://lopeaa.github.io/docs/public-key-infrastructure/code/code-controller-snippets/" class="nav-list-link">Controller Snippets</a></ul></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://lopeaa.github.io/docs/operating-systems" class="nav-list-link">Operating Systems</a><ul class="nav-list "><li class="nav-list-item "><a href="https://lopeaa.github.io/docs/operating-systems/centos/" class="nav-list-link">Centos</a><li class="nav-list-item "><a href="https://lopeaa.github.io/docs/operating-systems/ubuntu/" class="nav-list-link">Ubuntu 20.04</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://lopeaa.github.io/docs/utilities" class="nav-list-link">Utilities</a><ul class="nav-list "><li class="nav-list-item "><a href="https://lopeaa.github.io/docs/utilities/color/" class="nav-list-link">Color</a><li class="nav-list-item "><a href="https://lopeaa.github.io/docs/utilities/layout/" class="nav-list-link">Layout</a><li class="nav-list-item "><a href="https://lopeaa.github.io/docs/utilities/responsive-modifiers/" class="nav-list-link">Responsive Modifiers</a><li class="nav-list-item "><a href="https://lopeaa.github.io/docs/utilities/typography/" class="nav-list-link">Typography</a></ul></ul></nav><footer class="site-footer"> Copyright © 2017-2022 <a href="https://github.com/lopeaa/">Lopeaa</a>.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Made by mistake" aria-label="Search Made by mistake" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="https://liquabit.com/" class="site-button" target="_blank" rel="noopener noreferrer" > Prototypes site </a><li class="aux-nav-list-item"> <a href="//github.com/lopeaa/" class="site-button" target="_blank" rel="noopener noreferrer" > Github </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="https://lopeaa.github.io/docs/public-key-infrastructure">Public Key Infrastructure</a><li class="breadcrumb-nav-list-item"><a href="https://lopeaa.github.io/docs/public-key-infrastructure/code-snippets/">Code Snippets</a><li class="breadcrumb-nav-list-item"><span>View Snippets</span></ol></nav><div id="main-content" class="main-content" role="main"><h1 class="no_toc" id="certificate-authority-views"> <a href="#certificate-authority-views" class="anchor-heading" aria-labelledby="certificate-authority-views"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Certificate Authority Views</h1><h2 class="no_toc text-delta" id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents</h2><ol id="markdown-toc"><li><a href="#certificatecontrollerphp" id="markdown-toc-certificatecontrollerphp">CertificateController.php</a></ol><hr /><h1 id="certificatecontrollerphp"> <a href="#certificatecontrollerphp" class="anchor-heading" aria-labelledby="certificatecontrollerphp"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> CertificateController.php</h1><p>This Controller creates Certificates Keypair in one step and create and sign Certificate Signing Requests.</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">App\Http\Controllers\Admin</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Http\Controllers\Controller</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Http\Requests\MassDestroyCertificateKeyPair</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Http\Requests\StoreCertificateKeyPair</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Http\Requests\UpdateCertificate</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Cert</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Params</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Carbon\Carbon</span><span class="p">;</span>


<span class="kd">class</span> <span class="nc">CertificatesController</span> <span class="kd">extends</span> <span class="nc">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">index</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nf">abort_unless</span><span class="p">(</span><span class="err">\</span><span class="nc">Gate</span><span class="o">::</span><span class="nf">allows</span><span class="p">(</span><span class="s1">'certificate_access'</span><span class="p">),</span> <span class="mi">403</span><span class="p">);</span>

        <span class="nv">$certsNumber</span> <span class="o">=</span> <span class="nc">Cert</span><span class="o">::</span><span class="nf">all</span><span class="p">()</span><span class="o">-&gt;</span><span class="nb">count</span><span class="p">();</span>
        <span class="nv">$certs</span> <span class="o">=</span> <span class="nc">Cert</span><span class="o">::</span><span class="nf">all</span><span class="p">();</span>
        <span class="c1">// Chart - Certificates status.</span>
        <span class="nv">$certs_status_blank</span> <span class="o">=</span> <span class="nc">Cert</span><span class="o">::</span><span class="nf">where</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s1">'='</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">count</span><span class="p">();</span>
        <span class="nv">$certs_status_valid</span> <span class="o">=</span> <span class="nc">Cert</span><span class="o">::</span><span class="nf">where</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s1">'='</span><span class="p">,</span> <span class="s1">'Valid'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">count</span><span class="p">();</span>
        <span class="nv">$certs_status_expiring</span> <span class="o">=</span> <span class="nc">Cert</span><span class="o">::</span><span class="nf">where</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s1">'='</span><span class="p">,</span> <span class="s1">'Expiring'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">count</span><span class="p">();</span>
        <span class="nv">$certs_status_expired</span> <span class="o">=</span> <span class="nc">Cert</span><span class="o">::</span><span class="nf">where</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s1">'='</span><span class="p">,</span> <span class="s1">'Expired'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">count</span><span class="p">();</span>
        <span class="nv">$certs_status_revoked</span> <span class="o">=</span> <span class="nc">Cert</span><span class="o">::</span><span class="nf">where</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s1">'='</span><span class="p">,</span> <span class="s1">'Revoked'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">count</span><span class="p">();</span>
        <span class="c1">//dd($certs);</span>
        <span class="k">return</span> <span class="nf">view</span><span class="p">(</span><span class="s1">'admin.certs.index'</span><span class="p">,</span> <span class="nb">compact</span><span class="p">(</span><span class="s1">'certs'</span><span class="p">,</span>
                                                <span class="s1">'certsNumber'</span><span class="p">,</span>
                                                <span class="s1">'certs_status_blank'</span><span class="p">,</span>
                                                <span class="s1">'certs_status_valid'</span><span class="p">,</span>
                                                <span class="s1">'certs_status_expiring'</span><span class="p">,</span>
                                                <span class="s1">'certs_status_expired'</span><span class="p">,</span>
                                                <span class="s1">'certs_status_revoked'</span> <span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">create</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nf">abort_unless</span><span class="p">(</span><span class="err">\</span><span class="nc">Gate</span><span class="o">::</span><span class="nf">allows</span><span class="p">(</span><span class="s1">'certificate_create'</span><span class="p">),</span> <span class="mi">403</span><span class="p">);</span>

        <span class="nv">$params</span> <span class="o">=</span> <span class="nc">Params</span><span class="o">::</span><span class="nf">all</span><span class="p">();</span>

        <span class="k">return</span> <span class="nf">view</span><span class="p">(</span><span class="s1">'admin.certs.new-cert.create'</span><span class="p">,</span> <span class="nb">compact</span><span class="p">(</span><span class="s1">'params'</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">store</span><span class="p">(</span><span class="kt">StoreCertificateKeyPair</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">abort_unless</span><span class="p">(</span><span class="err">\</span><span class="nc">Gate</span><span class="o">::</span><span class="nf">allows</span><span class="p">(</span><span class="s1">'certificate_create'</span><span class="p">),</span> <span class="mi">403</span><span class="p">);</span>

            <span class="c1">// Separate CN and SANs.</span>
            <span class="nv">$commonName</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">";"</span><span class="p">,</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">subjectCommonName</span><span class="p">);</span>
			      <span class="nv">$subjectCommonName</span> <span class="o">=</span> <span class="nv">$commonName</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">//separated cn</span>
            <span class="nv">$extensionsSubjectAltName</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="p">(</span><span class="s2">"DNS:"</span><span class="mf">.</span><span class="nb">implode</span><span class="p">(</span><span class="s2">",DNS:"</span><span class="p">,</span> <span class="nv">$commonName</span><span class="p">)));</span>
            <span class="nv">$extensionsSubjectAltName</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="nv">$extensionsSubjectAltName</span><span class="p">);</span> <span class="c1">// Separated SANs</span>

            <span class="nv">$config</span> <span class="o">=</span> <span class="nv">$OPENSSL_CONFIG</span><span class="p">;</span>

            <span class="c1">// Check if CN already exists.</span>
            <span class="nc">Cert</span><span class="o">::</span><span class="nf">where</span><span class="p">(</span><span class="s1">'subjectCommonName'</span><span class="p">,</span> <span class="s1">'='</span><span class="p">,</span> <span class="nv">$subjectCommonName</span><span class="p">);</span>
            <span class="nc">Cert</span><span class="o">::</span><span class="nf">where</span><span class="p">(</span><span class="s1">'subjectCommonName'</span><span class="p">,</span> <span class="s1">'='</span><span class="p">,</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

            <span class="cd">/** Data needed to populate the certificate signed by this CA.
            email can´t be empty so if it is empty "emailAddress" is not included. **/</span>

            <span class="k">if</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="n">email</span> <span class="o">!=</span> <span class="s1">''</span><span class="p">){</span>
                  <span class="nv">$dn</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
                     <span class="s2">"countryName"</span> <span class="o">=&gt;</span> <span class="nv">$countryName</span><span class="p">,</span> 
                     <span class="s2">"stateOrProvinceName"</span> <span class="o">=&gt;</span> <span class="nv">$stateOrProvinceName</span><span class="p">,</span>
                     <span class="s2">"localityName"</span> <span class="o">=&gt;</span> <span class="nv">$localityName</span><span class="p">,</span>
                     <span class="s2">"organizationName"</span> <span class="o">=&gt;</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">subjectOrganization</span><span class="p">,</span>
                     <span class="s2">"organizationalUnitName"</span> <span class="o">=&gt;</span> <span class="nv">$orgUnitName</span><span class="p">,</span>
                     <span class="s2">"commonName"</span> <span class="o">=&gt;</span> <span class="nv">$subjectCommonName</span><span class="p">,</span>
                     <span class="s2">"emailAddress"</span> <span class="o">=&gt;</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">email</span>
                     <span class="p">);</span>
             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nv">$dn</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
                     <span class="s2">"countryName"</span> <span class="o">=&gt;</span> <span class="nv">$countryName</span><span class="p">,</span>
                     <span class="s2">"stateOrProvinceName"</span> <span class="o">=&gt;</span> <span class="nv">$stateOrProvinceName</span><span class="p">,</span>
                     <span class="s2">"localityName"</span> <span class="o">=&gt;</span> <span class="nv">$localityName</span><span class="p">,</span>
                     <span class="s2">"organizationName"</span> <span class="o">=&gt;</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">subjectOrganization</span><span class="p">,</span>
                     <span class="s2">"organizationalUnitName"</span> <span class="o">=&gt;</span> <span class="nv">$orgUnitName</span><span class="p">,</span>
                     <span class="s2">"commonName"</span> <span class="o">=&gt;</span> <span class="nv">$subjectCommonName</span><span class="p">,</span>
                     <span class="s2">"emailAddress"</span> <span class="o">=&gt;</span> <span class="kc">null</span>
                     <span class="p">);</span>
               <span class="p">}</span>

            <span class="cd">/** Clean DNS entries. **/</span>
            <span class="nb">shell_exec</span><span class="p">(</span><span class="s2">"/opt/subjectAltNameRemoval.sh 2&gt;&amp;1"</span><span class="p">);</span>
            <span class="nv">$configFile</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$config</span><span class="p">);</span>
            <span class="nv">$configFile</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s2">"DNS:"</span><span class="p">,</span> <span class="nv">$extensionsSubjectAltName</span><span class="p">,</span> <span class="nv">$configFile</span><span class="p">);</span>
            
            <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$config</span><span class="p">,</span> <span class="nv">$configFile</span><span class="p">);</span>
            <span class="nb">unset</span><span class="p">(</span><span class="nv">$configFile</span><span class="p">);</span>

            <span class="cd">/** Arguments to be passed to the CSR **/</span>
            <span class="nv">$configArgs</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">'config'</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="p">,</span>
                <span class="s1">'encrypt_key'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
                <span class="s1">'private_key_type'</span> <span class="o">=&gt;</span> <span class="no">OPENSSL_KEYTYPE_RSA</span><span class="p">,</span>
                <span class="s1">'subjectAltName'</span> <span class="o">=&gt;</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">extensionsSubjectAltName</span><span class="p">,</span>
                <span class="s1">'digest_alg'</span> <span class="o">=&gt;</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">signatureTypeSN</span> <span class="p">);</span>

            <span class="c1">// Generate REQ and his corresponding Private Key.</span>
            <span class="nv">$keygen</span> <span class="o">=</span> <span class="nb">openssl_pkey_new</span><span class="p">();</span>
            <span class="nv">$reqgen</span> <span class="o">=</span> <span class="nb">openssl_csr_new</span><span class="p">(</span><span class="nv">$dn</span><span class="p">,</span> <span class="nv">$keygen</span><span class="p">,</span> <span class="nv">$configArgs</span><span class="p">);</span>

            <span class="c1">// Export Private Key to string.</span>
            <span class="nb">openssl_pkey_export</span><span class="p">(</span><span class="nv">$keygen</span><span class="p">,</span> <span class="nv">$privateKey</span><span class="p">);</span>

            <span class="c1">// Export CSR to string.</span>
            <span class="nb">openssl_csr_export</span><span class="p">(</span><span class="nv">$reqgen</span><span class="p">,</span> <span class="nv">$certificateServerRequest</span><span class="p">);</span>

            <span class="c1">// Signing CSR. Location of CA Pub/Priv certificates.</span>
            <span class="nv">$cacert</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'/opt/ca/cacert.pem'</span><span class="p">);</span>
            <span class="nv">$pkeyid</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'/opt/ca/private/cakey.pem'</span><span class="p">),</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">password</span> <span class="p">);</span>
            <span class="nv">$configArgs</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
                    <span class="s1">'config'</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="p">,</span>
                    <span class="s1">'encrypt_key'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
                    <span class="s1">'private_key_bits'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">int</span><span class="p">)</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="n">keyLength</span><span class="p">,</span>
                    <span class="s1">'private_key_type'</span> <span class="o">=&gt;</span> <span class="no">OPENSSL_KEYTYPE_RSA</span><span class="p">,</span>
                    <span class="s1">'digest_alg'</span> <span class="o">=&gt;</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">signatureTypeSN</span><span class="p">,</span>
                    <span class="s1">'x509_extensions'</span> <span class="o">=&gt;</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">extensionsExtendedKeyUsage</span><span class="p">);</span>
            
            <span class="c1">// Insert serial number.</span>
            <span class="nv">$serialNumber</span> <span class="o">=</span> <span class="nb">random_int</span><span class="p">(</span><span class="mi">160000000001</span><span class="p">,</span> <span class="mi">170000000001</span><span class="p">);</span>

            <span class="c1">// Sign Certificate Server Request.</span>
            <span class="nv">$certgen</span> <span class="o">=</span> <span class="nb">openssl_csr_sign</span><span class="p">(</span><span class="nv">$certificateServerRequest</span> <span class="p">,</span> <span class="nv">$cacert</span><span class="p">,</span> <span class="nv">$pkeyid</span><span class="p">,</span>
             <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">validityPeriod</span><span class="p">,</span> <span class="nv">$configArgs</span><span class="p">,</span> <span class="nv">$serialNumber</span><span class="p">);</span>

            <span class="c1">// Export signed certificate to string variable.</span>
            <span class="nb">openssl_x509_export</span><span class="p">(</span><span class="nv">$certgen</span><span class="p">,</span> <span class="nv">$publicKey</span><span class="p">);</span> 

            <span class="c1">// Clean SAN DNS entries.</span>
            <span class="nb">shell_exec</span><span class="p">(</span><span class="s2">"sudo /opt/subjectAltNameRemoval.sh 2&gt;&amp;1"</span><span class="p">);</span>

            <span class="c1">// Parse certificate data.</span>
            <span class="nv">$certParser</span> <span class="o">=</span> <span class="nb">openssl_x509_parse</span><span class="p">(</span><span class="nv">$publicKey</span><span class="p">);</span>
            <span class="c1">// Include certificate parse data in request. </span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'subjectCommonName'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">][</span><span class="s1">'CN'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'subjectContry'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">][</span><span class="s1">'C'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'subjectState'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">][</span><span class="s1">'ST'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'subjectOrganization'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">][</span><span class="s1">'O'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'subjectOrganizationUnit'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">][</span><span class="s1">'OU'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'hash'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'hash'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'issuerCN'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'issuer'</span><span class="p">][</span><span class="s1">'CN'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'issuerOrganization'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'issuer'</span><span class="p">][</span><span class="s1">'O'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'issuerOrganizationUnit'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'issuer'</span><span class="p">][</span><span class="s1">'OU'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'version'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'version'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'serialNumber'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$serialNumber</span><span class="p">;</span>
            <span class="c1">//$request['serialNumberHex'] = $serialNumberHex;</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'validFrom'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'validFrom'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'validTo'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'validTo'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'validFrom_time_t'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'validFrom_time_t'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'validTo_time_t'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'validTo_time_t'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'signatureTypeSN'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'signatureTypeSN'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'signatureTypeLN'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'signatureTypeLN'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'signatureTypeNID'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'signatureTypeNID'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'purposes'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'extensionsBasicConstraints'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">][</span><span class="s1">'basicConstraints'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'extensionsKeyUsage'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">][</span><span class="s1">'keyUsage'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'extensionsExtendedKeyUsage'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">][</span><span class="s1">'extendedKeyUsage'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'extensionsSubjectKeyIdentifier'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">][</span><span class="s1">'subjectKeyIdentifier'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'extensionsAuthorityKeyIdentifier'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">][</span><span class="s1">'authorityKeyIdentifier'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'extensionsSubjectAltName'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">][</span><span class="s1">'subjectAltName'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'extensionsCrlDistributionPoints'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">][</span><span class="s1">'crlDistributionPoints'</span><span class="p">];</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'certificateServerRequest'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$certificateServerRequest</span><span class="p">;</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'publicKey'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$publicKey</span><span class="p">;</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'privateKey'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$privateKey</span><span class="p">;</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Valid'</span><span class="p">;</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'p12'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="c1">// Convert dates.</span>
            <span class="c1">//$validFrom_time_t = date(DATE_RFC2822, $certParser['validFrom_time_t']);</span>
            <span class="nv">$validTo_time_t</span> <span class="o">=</span> <span class="nb">date</span><span class="p">(</span><span class="no">DATE_RFC2822</span><span class="p">,</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'validTo_time_t'</span><span class="p">]);</span>
            <span class="nv">$expiryDate</span> <span class="o">=</span> <span class="nc">Carbon</span><span class="o">::</span><span class="nf">parse</span><span class="p">(</span><span class="nc">Carbon</span><span class="o">::</span><span class="nf">now</span><span class="p">())</span><span class="o">-&gt;</span><span class="nf">diffInDays</span><span class="p">(</span><span class="nv">$validTo_time_t</span><span class="p">);</span>
            <span class="nv">$request</span><span class="p">[</span><span class="s1">'expiryDate'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$expiryDate</span><span class="p">;</span>

            <span class="c1">//dd($request['expiryDate']);</span>

            <span class="nc">Cert</span><span class="o">::</span><span class="nf">create</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">all</span><span class="p">());</span>

        <span class="k">return</span> <span class="nf">redirect</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">route</span><span class="p">(</span><span class="s1">'admin.certs.index'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">edit</span><span class="p">(</span><span class="kt">Cert</span> <span class="nv">$cert</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">abort_unless</span><span class="p">(</span><span class="err">\</span><span class="nc">Gate</span><span class="o">::</span><span class="nf">allows</span><span class="p">(</span><span class="s1">'certificate_edit'</span><span class="p">),</span> <span class="mi">403</span><span class="p">);</span>

        <span class="k">return</span> <span class="nf">view</span><span class="p">(</span><span class="s1">'admin.certs.edit'</span><span class="p">,</span> <span class="nb">compact</span><span class="p">(</span><span class="s1">'cert'</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">update</span><span class="p">(</span><span class="kt">UpdateCertificate</span> <span class="nv">$request</span><span class="p">,</span> <span class="kt">Cert</span> <span class="nv">$cert</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">abort_unless</span><span class="p">(</span><span class="err">\</span><span class="nc">Gate</span><span class="o">::</span><span class="nf">allows</span><span class="p">(</span><span class="s1">'certificate_edit'</span><span class="p">),</span> <span class="mi">403</span><span class="p">);</span>

        <span class="c1">// $cert-&gt;update($request-&gt;all());</span>
        <span class="nv">$cert</span><span class="o">-&gt;</span><span class="nf">update</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">all</span><span class="p">(</span><span class="s1">'certificateServerRequest'</span><span class="p">));</span>
        <span class="nv">$cert</span><span class="o">-&gt;</span><span class="nf">update</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">all</span><span class="p">(</span><span class="s1">'publicKey'</span><span class="p">));</span>
        <span class="nv">$cert</span><span class="o">-&gt;</span><span class="nf">update</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">all</span><span class="p">(</span><span class="s1">'privateKey'</span><span class="p">));</span>
        <span class="nv">$cert</span><span class="o">-&gt;</span><span class="nf">update</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">all</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">));</span>

        <span class="cd">/** logic to update all DB tables when PublicKey change. **/</span> 
        <span class="k">if</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">all</span><span class="p">(</span><span class="s1">'publicKey'</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$certParser</span> <span class="o">=</span> <span class="nb">openssl_x509_parse</span><span class="p">(</span><span class="nv">$publicKey</span><span class="p">);</span>
            <span class="c1">//dd($certParser);</span>
            <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'name'</span><span class="p">];</span>
            <span class="nv">$subject</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">];</span>
                <span class="nv">$subjectCommonName</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">][</span><span class="s1">'CN'</span><span class="p">];</span>
                <span class="c1">//$subjectEmail = $certParser['subject']['emailAddress'];</span>
                <span class="nv">$subjectContry</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">][</span><span class="s1">'C'</span><span class="p">];</span>
                <span class="c1">//$subjectState = $certParser['subject']['ST'];</span>
                <span class="c1">//$subjectLocality = $certParser['subject']['L'];</span>
                <span class="nv">$subjectOrganization</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">][</span><span class="s1">'O'</span><span class="p">];</span>
                <span class="c1">//$subjectOrganizationUnit = $certParser['subject']['OU'];</span>
            <span class="nv">$hash</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'hash'</span><span class="p">];</span>
            <span class="nv">$issuer</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'issuer'</span><span class="p">];</span>
              <span class="k">if</span><span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$issuer</span><span class="p">[</span><span class="s1">'CN'</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$issuerCN</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> 
              <span class="p">}</span> <span class="k">else</span><span class="p">{</span>
                <span class="nv">$issuerCN</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'issuer'</span><span class="p">][</span><span class="s1">'CN'</span><span class="p">];</span>
              <span class="p">}</span>
              <span class="k">if</span><span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$issuer</span><span class="p">[</span><span class="s1">'C'</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$issuerContry</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$issuerContry</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'issuer'</span><span class="p">][</span><span class="s1">'C'</span><span class="p">];</span>
              <span class="p">}</span>
              <span class="k">if</span><span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$issuer</span><span class="p">[</span><span class="s1">'O'</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$issuerOrganization</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$issuerOrganization</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'issuer'</span><span class="p">][</span><span class="s1">'O'</span><span class="p">];</span>
              <span class="p">}</span>
  
                <span class="c1">//$issuerCN = $certParser['issuer']['CN'];</span>
                <span class="c1">//$issuerContry = $certParser['issuer']['C'];</span>
                <span class="c1">//$issuerState = $certParser['issuer']['ST'];</span>
                <span class="c1">//$issuerLocality = $certParser['issuer']['L'];</span>
                <span class="c1">//$issuerOrganization = $certParser['issuer']['O'];</span>
                <span class="c1">//$issuerOrganizationUnit = $certParser['issuer']['OU'];</span>
            <span class="nv">$version</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'version'</span><span class="p">];</span>
            <span class="nv">$serialNumber</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'serialNumber'</span><span class="p">];</span>
            <span class="nv">$serialNumberHex</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'serialNumberHex'</span><span class="p">];</span>
            <span class="nv">$validFrom</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'validFrom'</span><span class="p">];</span>
            <span class="nv">$validTo</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'validTo'</span><span class="p">];</span>
            <span class="nv">$validFrom_time_t</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'validFrom_time_t'</span><span class="p">];</span>
            <span class="nv">$validTo_time_t</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'validTo_time_t'</span><span class="p">];</span>
            <span class="nv">$signatureTypeSN</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'signatureTypeSN'</span><span class="p">];</span>
            <span class="nv">$signatureTypeLN</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'signatureTypeLN'</span><span class="p">];</span>
            <span class="nv">$signatureTypeNID</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'signatureTypeNID'</span><span class="p">];</span>
            <span class="c1">//$purposes = $certParser['purposes']['1']['2']; dd($purposes);</span>
            <span class="nv">$purposes</span> <span class="o">=</span> <span class="s1">'Not Implemented'</span><span class="p">;</span>
            <span class="nv">$extensions</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">];</span>
                <span class="nv">$extensionsBasicConstraints</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">][</span><span class="s1">'basicConstraints'</span><span class="p">];</span>
                <span class="c1">//$extensionsNsCertType = $certParser['extensions']['nsCertType'];</span>
                <span class="c1">//$extensionsKeyUsage = $certParser['extensions']['keyUsage'];</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">][</span><span class="s1">'keyUsage'</span><span class="p">])){</span>
                  <span class="nv">$extensionsKeyUsage</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nv">$extensionsKeyUsage</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">][</span><span class="s1">'keyUsage'</span><span class="p">];</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">][</span><span class="s1">'extendedKeyUsage'</span><span class="p">])){</span>
                  <span class="nv">$extensionsExtendedKeyUsage</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nv">$extensionsExtendedKeyUsage</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">][</span><span class="s1">'extendedKeyUsage'</span><span class="p">];</span>  
                <span class="p">}</span>
  
                <span class="c1">//$extensionsExtendedKeyUsage = $certParser['extensions']['extendedKeyUsage'];</span>
                <span class="c1">//$extensionsSubjectKeyIdentifier = $certParser['extensions']['subjectKeyIdentifier'];</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">][</span><span class="s1">'authorityKeyIdentifier'</span><span class="p">])){</span>
                  <span class="nv">$extensionsAuthorityKeyIdentifier</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nv">$extensionsAuthorityKeyIdentifier</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">][</span><span class="s1">'authorityKeyIdentifier'</span><span class="p">];</span>
                <span class="p">}</span>
                <span class="c1">//$extensionsAuthorityKeyIdentifier = $certParser['extensions']['authorityKeyIdentifier'];</span>
                <span class="nv">$extensionsSubjectAltName</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">][</span><span class="s1">'subjectAltName'</span><span class="p">];</span>
                <span class="nv">$extensionsCrlDistributionPoints</span> <span class="o">=</span> <span class="nv">$certParser</span><span class="p">[</span><span class="s1">'extensions'</span><span class="p">][</span><span class="s1">'crlDistributionPoints'</span><span class="p">];</span>
            <span class="c1">// End Certificate Info</span>
            <span class="nv">$expiryDate</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="nb">time</span><span class="p">()</span> <span class="o">-</span> <span class="nv">$validTo_time_t</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">));</span> <span class="c1">// In days</span>
            <span class="nv">$status</span> <span class="o">=</span> <span class="s1">'Valid'</span><span class="p">;</span>
            <span class="c1">// for testing purposes</span>
            <span class="nv">$p12</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  
            <span class="c1">// Place the certificate publickey in public-keys to be monitored.</span>
            <span class="nb">openssl_x509_export_to_file</span><span class="p">(</span><span class="nv">$publicKey</span><span class="p">,</span> <span class="nf">storage_path</span><span class="p">(</span><span class="s1">'public-keys/'</span> <span class="mf">.</span> <span class="nv">$subjectCommonName</span> <span class="mf">.</span> <span class="s1">'.crt'</span><span class="p">));</span>
  
            <span class="c1">// Insert new PublicKey and update data </span>
            <span class="c1">// Cert::where('subjectCommonName', $subjectCommonName)-&gt;update(['publicKey' =&gt; $publicKey]);</span>
            <span class="nc">Cert</span><span class="o">::</span><span class="nf">where</span><span class="p">(</span><span class="s1">'subjectCommonName'</span><span class="p">,</span> <span class="nv">$subjectCommonName</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">update</span><span class="p">([</span>
              <span class="c1">//'subjectCommonName' =&gt; $subjectCommonName,</span>
              <span class="c1">//'subjectEmail' =&gt; $subjectEmail,</span>
              <span class="s1">'subjectContry'</span> <span class="o">=&gt;</span> <span class="nv">$subjectContry</span><span class="p">,</span>
              <span class="c1">//'subjectState' =&gt; $subjectState,</span>
              <span class="c1">//'subjectLocality' =&gt; $subjectLocality,</span>
              <span class="s1">'subjectOrganization'</span> <span class="o">=&gt;</span> <span class="nv">$subjectOrganization</span><span class="p">,</span>
              <span class="c1">//'subjectOrganizationUnit' =&gt; $subjectOrganizationUnit,</span>
              <span class="s1">'hash'</span> <span class="o">=&gt;</span> <span class="nv">$hash</span><span class="p">,</span>
              <span class="s1">'issuerCN'</span> <span class="o">=&gt;</span> <span class="nv">$issuerCN</span><span class="p">,</span>
              <span class="s1">'issuerContry'</span> <span class="o">=&gt;</span> <span class="nv">$issuerContry</span><span class="p">,</span>
              <span class="c1">//'issuerState' =&gt; $issuerState,</span>
              <span class="c1">//'issuerLocality' =&gt; $issuerLocality,</span>
              <span class="s1">'issuerOrganization'</span> <span class="o">=&gt;</span> <span class="nv">$issuerOrganization</span><span class="p">,</span>
              <span class="c1">//'issuerOrganizationUnit' =&gt; $issuerOrganizationUnit,</span>
              <span class="s1">'version'</span> <span class="o">=&gt;</span> <span class="nv">$version</span><span class="p">,</span>
              <span class="s1">'serialNumber'</span> <span class="o">=&gt;</span> <span class="nv">$serialNumber</span><span class="p">,</span>
              <span class="s1">'serialNumberHex'</span> <span class="o">=&gt;</span> <span class="nv">$serialNumberHex</span><span class="p">,</span>
              <span class="s1">'validFrom'</span> <span class="o">=&gt;</span> <span class="nv">$validFrom</span><span class="p">,</span>
              <span class="s1">'validTo'</span> <span class="o">=&gt;</span> <span class="nv">$validTo</span><span class="p">,</span>
              <span class="s1">'validFrom_time_t'</span> <span class="o">=&gt;</span> <span class="nv">$validFrom_time_t</span><span class="p">,</span>
              <span class="s1">'validTo_time_t'</span> <span class="o">=&gt;</span> <span class="nv">$validTo_time_t</span><span class="p">,</span>
              <span class="s1">'signatureTypeSN'</span> <span class="o">=&gt;</span> <span class="nv">$signatureTypeSN</span><span class="p">,</span>
              <span class="s1">'signatureTypeLN'</span> <span class="o">=&gt;</span> <span class="nv">$signatureTypeLN</span><span class="p">,</span>
              <span class="s1">'signatureTypeNID'</span> <span class="o">=&gt;</span> <span class="nv">$signatureTypeNID</span><span class="p">,</span>
              <span class="s1">'purposes'</span> <span class="o">=&gt;</span> <span class="nv">$purposes</span><span class="p">,</span>
              <span class="s1">'extensionsBasicConstraints'</span> <span class="o">=&gt;</span> <span class="nv">$extensionsBasicConstraints</span><span class="p">,</span>
              <span class="c1">//'extensionsNsCertType' =&gt; $extensionsNsCertType,</span>
              <span class="s1">'extensionsKeyUsage'</span> <span class="o">=&gt;</span> <span class="nv">$extensionsKeyUsage</span><span class="p">,</span>
              <span class="s1">'extensionsExtendedKeyUsage'</span> <span class="o">=&gt;</span> <span class="nv">$extensionsExtendedKeyUsage</span><span class="p">,</span>
              <span class="c1">//'extensionsSubjectKeyIdentifier' =&gt; $extensionsSubjectKeyIdentifier,</span>
              <span class="s1">'extensionsAuthorityKeyIdentifier'</span> <span class="o">=&gt;</span> <span class="nv">$extensionsAuthorityKeyIdentifier</span><span class="p">,</span>
              <span class="s1">'extensionsSubjectAltName'</span> <span class="o">=&gt;</span> <span class="nv">$extensionsSubjectAltName</span><span class="p">,</span>
              <span class="s1">'extensionsCrlDistributionPoints'</span> <span class="o">=&gt;</span> <span class="nv">$extensionsCrlDistributionPoints</span><span class="p">,</span>
              <span class="c1">//'certificateServerRequest' =&gt; $certificateServerRequest,</span>
              <span class="s1">'publicKey'</span> <span class="o">=&gt;</span> <span class="nv">$publicKey</span><span class="p">,</span>
              <span class="c1">// 'privateKey' =&gt; $privateKey,</span>
              <span class="s1">'p12'</span> <span class="o">=&gt;</span> <span class="nv">$p12</span><span class="p">,</span>
              <span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="nv">$status</span><span class="p">,</span>
              <span class="s1">'expiryDate'</span> <span class="o">=&gt;</span> <span class="nv">$expiryDate</span><span class="p">,</span>
              <span class="c1">//'email' =&gt; $email,</span>
              <span class="s1">'comments'</span> <span class="o">=&gt;</span> <span class="nv">$comments</span>
              <span class="p">]);</span>
   
          <span class="p">}</span>


        <span class="cd">/** Also, before updating csr/pub/priv keys, make a Keymatch for more security. **/</span>

        <span class="k">return</span> <span class="nf">redirect</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">route</span><span class="p">(</span><span class="s1">'admin.certs.index'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">show</span><span class="p">(</span><span class="kt">Cert</span> <span class="nv">$cert</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">abort_unless</span><span class="p">(</span><span class="err">\</span><span class="nc">Gate</span><span class="o">::</span><span class="nf">allows</span><span class="p">(</span><span class="s1">'certificate_show'</span><span class="p">),</span> <span class="mi">403</span><span class="p">);</span>

        <span class="c1">// Convert dates validFrom and validTo to show them properly in view.</span>
        <span class="nv">$certs</span> <span class="o">=</span> <span class="nc">Cert</span><span class="o">::</span><span class="nf">all</span><span class="p">();</span>

        <span class="nv">$validFrom_time_t</span> <span class="o">=</span> <span class="nb">date</span><span class="p">(</span><span class="no">DATE_RFC2822</span><span class="p">,</span> <span class="nv">$cert</span><span class="o">-&gt;</span><span class="n">validFrom_time_t</span><span class="p">);</span>
        <span class="nv">$validTo_time_t</span> <span class="o">=</span> <span class="nb">date</span><span class="p">(</span><span class="no">DATE_RFC2822</span><span class="p">,</span> <span class="nv">$cert</span><span class="o">-&gt;</span><span class="n">validTo_time_t</span><span class="p">);</span>

        <span class="c1">//$validFrom = date(DATE_RFC2822, $certParser['validFrom']);</span>
        <span class="c1">//dd($validFrom_time_t, $validTo_time_t);</span>

        <span class="k">return</span> <span class="nf">view</span><span class="p">(</span><span class="s1">'admin.certs.show'</span><span class="p">,</span> <span class="nb">compact</span><span class="p">(</span><span class="s1">'cert'</span><span class="p">,</span> <span class="s1">'validFrom_time_t'</span><span class="p">,</span> <span class="s1">'validTo_time_t'</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">destroy</span><span class="p">(</span><span class="kt">Cert</span> <span class="nv">$cert</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">abort_unless</span><span class="p">(</span><span class="err">\</span><span class="nc">Gate</span><span class="o">::</span><span class="nf">allows</span><span class="p">(</span><span class="s1">'certificate_delete'</span><span class="p">),</span> <span class="mi">403</span><span class="p">);</span>

        <span class="nv">$cert</span><span class="o">-&gt;</span><span class="nb">delete</span><span class="p">();</span>

        <span class="k">return</span> <span class="nf">back</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">massDestroy</span><span class="p">(</span><span class="kt">MassDestroyCertificateKeyPair</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nc">Cert</span><span class="o">::</span><span class="nf">whereIn</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nf">request</span><span class="p">(</span><span class="s1">'ids'</span><span class="p">))</span><span class="o">-&gt;</span><span class="nb">delete</span><span class="p">();</span>

        <span class="k">return</span> <span class="nf">response</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="mi">204</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0">Everything must be made as simple as possible. But not simpler.</p></footer></div></div><div class="search-overlay"></div></div>
